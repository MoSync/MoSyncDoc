<html>
<head>
<!-- <mosyncheadertags>
<meta name="description" content="A unique feature of the MoSync SDK is its ability to handle hybrid mobile apps: Mobile applications that mix HTML5, JavaScript and C/C++." />
<meta name="dcterms.description" content="A unique feature of the MoSync SDK is its ability to handle hybrid mobile apps: Mobile applications that mix HTML5, JavaScript and C/C++." />

<title>Event Handling in a MoSync Hybrid Mobile App | MoSync Guide/Tutorial</title>
</mosyncheadertags> -->
</head>
<body>
<h1>Event Handling in a MoSync Hybrid Mobile App</h1>
<p>A unique feature of the MoSync SDK is its ability to handle hybrid mobile apps: Mobile applications that mix HTML5, JavaScript and C/C++. In this overview we look at the event handling architecture of a hybrid app, with a particular focus on the Wormhole Libraries' handling of events and messages between the HTML5 and C/C++ layers of your app, and the MoSync Runtime on the device.<!--break--></p>
<h2>Processing Flow for an Event</h2>
<p>In the following flowchart we show a high-level view of the processing of an event in a running hybrid app. The event is the pressing of the BACK key on the device. In the flowchart we show the default processing in a standard MoSync SDK template; the template we have chosen is the MoSync <a href="TEMPLATE_DOC_PATH/sdk/tools/guides/ide/projects-and-templates/index.html#HTML5JSC_Hybrid_Project">HTML5/JS/C++ Hybrid Project</a> template which includes event handling in both HTML5/JavaScript and in C/C++, and well illustrates the roles played by both the <a href="http://www.mosync.com/files/imports/doxygen/latest/html5/index.html">Wormhole JavaScript Library</a> and <a href="http://www.mosync.com/files/imports/doxygen/latest/html/namespace_wormhole.html">Wormhole C++ Library</a>.</p>
<p><img src="images/MoSyncHTML5KeyPressEventSimpleNarrow_1.png" align="none" width="578" height="883"></p>
<h2>Call Sequence</h2>
<p><img src="images/ared1_0.png" align="left" width="25" height="23">When the body of your application's web page loads, the JavaScript <strong>initialize</strong> function in the page's head section gets called. That function sets up a listener for "backbutton" events. Later, when that listener hears such an event, it will call the <strong>close</strong> function:</p>
<pre class="mosync-code-cpp">function initialize() {
    document.addEventListener("backbutton", close, true);
}

function close() {
    mosync.bridge.send([ "close" ]);
}</pre>
<p>The "backbutton" event is actually a <em>custom</em> event type that's defined in the <a href="http://www.mosync.com/files/imports/doxygen/latest/html5/index.html">Wormhole JavaScript Library</a>, extending the standard event listening functionality of HTML5.</p>
<p><img src="images/ared2.png" align="left" width="25" height="23">In the running app, when the <a href="TEMPLATE_DOC_PATH/sdk/tools/guides/architecture/runtime-architecture/index.html">MoSync Runtime</a> code on the device detects (via the device's operating system) that a key has been pressed, it calls the generic handler for events within your app's C++ moblet, passing along the key codes that identify the key that has been pressed.<br><br>(A moblet is an object that represents a MoSync application in the C++ world. For more about moblets, see its <a href="http://www.mosync.com/files/imports/doxygen/latest/html/class_m_a_util_1_1_moblet.html">C++ class reference</a>, the <a href="TEMPLATE_DOC_PATH/sdk/cpp/examples/hellomoblet/index.html">HelloMoblet </a>example application, our tutorials <a href="TEMPLATE_DOC_PATH/sdk/cpp/guides/hello-world-deconstructed/index.html">HelloWorld, Deconstructed</a> and <a href="TEMPLATE_DOC_PATH/sdk/cpp/guides/maui/starting-new-moblet-project/index.html">Starting a New Moblet Project</a>, or Mikael Kindborg's excellent <a href="http://divineprogrammer.blogspot.se/2012/03/developing-mobile-apps-in-mosync.html">Developing mobile apps in MoSync - designing classes for code reuse</a>.)<br><br><img src="images/ared3.png" align="left" width="25" height="23">You can use the <strong>KeyPressEvent</strong> within your application's implementation of the <strong>WebAppMoblet</strong> (i.e., within <strong>MyMoblet</strong>) to specify special handling for different keys. The <strong>WebAppMoblet</strong> is the base class for any MoSync application that uses NativeUI <strong>WebView</strong> widgets. It inherits from <strong>MAUtil::Moblet</strong>, the base C++ class for all MoSync applications.</p>
<p>The <strong>WebAppMoblet</strong> adds functionality to the basic Moblet class that enables it to interact with WebView widgets. For example it adds the <strong>callJS</strong> method that can be used to run JavaScript code in the WebView, and the <strong>handleWebViewMessage</strong> method that deals with messages coming from the WebView.</p>
<p>In your implementation of the <strong>Moblet</strong> class you can override these and other methods inherited from <strong>Moblet</strong> and <strong>WebViewMoblet</strong>. For more information, see <a href="TEMPLATE_DOC_PATH/sdk/js/guides/wormhole/extending-javascript-with-cpp/index.html">Extending HTML5 Apps with C++</a>.</p>
<p>In the default MoSync HTML5/JS/C++hybrid template, the key codes in the <strong>KeyPressEvent</strong> are simply forwarded to the <strong>PhoneGapMessageHandler</strong> which is part of the MoSync Wormhole C++ Library. (As the Wormhole C++ Library is precompiled, you can't see its source in the IDE. If you want to look at the library code you can find it in the MoSync Project Repository on <a href="https://github.com/MoSync/MoSync/blob/master/libs/Wormhole/Libs/PhoneGap/PhoneGapMessageHandler.cpp">GitHub</a>.)<br><br><img src="images/ared4.png" align="left" width="25" height="23">The <strong>processKeyEvent</strong> method of the <strong>PhoneGapMessageHandler</strong> checks the key codes sent from the moblet and, if it is the code for the back key, it uses the <strong>callJS</strong> method to call a JavaScript function in the HTML5 layer of the app:</p>
<pre class="mosync-code-cpp">void PhoneGapMessageHandler::processKeyEvent(int keyCode, int nativeKeyCode)
{
    if (MAK_BACK == keyCode)
    {
    callJS("PhoneGapCommandResult('backbutton');");
    }
}

void WebAppMoblet::callJS(const MAUtil::String&amp; script)
{
    getWebView()-&gt;callJS(script);
}</pre>
<p>Note that the key code has now been replaced by a status string "backbutton".<br><br><img src="images/ared5.png" align="left" width="25" height="23">The called function is <strong>PhoneGapCommandResult</strong> which is a function in the MoSync Wormhole JavaScript Library. You can find this library in the <em>LocalFiles/js</em> folder in your application project. <br><br>In the default hybrid template, the function checks to see if the status string is "backbutton", and if so calls a <a href="http://phonegap.com/">PhoneGap</a> function called <strong>fireEvent</strong>. The <strong>fireEvent</strong> function creates an event and dispatches it to the HTML document object (i.e. your web page) where it will be detected by the listener for that event type that was set up in step 1.<br><br><img src="images/ared6.png" align="left" width="25" height="23">The "close" message string is handled by the <a href="http://www.mosync.com/files/imports/doxygen/latest/html5/mosync-bridge.js.html#bridge.send">MoSync Bridge</a>, a part of the Wormhole JavaScript Library. The Bridge sends the "close" message to the MoSync Runtime code on the device.<br><br><img src="images/ared7.png" align="left" width="25" height="23">The MoSync Runtime now sends a "close" message to the application moblet where it is dealt with, first by the moblet's generic <strong>handleWebViewMessage</strong> method, then by the specific <strong>handleMessageStream</strong> method.<br><br><img src="images/ared8.png" align="left" width="25" height="23">In the default hybrid template, the standard moblet close method is now called. Again the source code for moblets is in a precompiled library (in this case <strong>MAUtil</strong>), but you can find it in <a href="https://github.com/MoSync/MoSync/blob/master/libs/MAUtil/Moblet.cpp">GitHub</a> if you need it.<br><br><img src="images/ared9.png" align="left" width="25" height="23">The moblet closes the app by invoking the MoSync syscall function <strong>maExit</strong> in the MoSync Runtime. (For documentation of this syscall, and all other MoSync syscalls and IOCTLs, see its entry in <a href="http://www.mosync.com/files/imports/doxygen/latest/html/maapi_8h.html">maapi.h</a>.)<br><br><img src="images/ared10.png" align="left" width="25" height="23">Finally the MoSync Runtime instructs the device's OS to close the app (for example, on Android) or, on platforms that do not allow an app to close itself (for example, on iOS or Windows Phone 7), simply discards the instruction.</p>
</body>
</html>
